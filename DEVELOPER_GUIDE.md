# developer guide

## overview

Arrranger is a tool for synchronizing media library information between radarr and sonarr instances. it supports both manual and automatic operations, with advanced filtering (in future releases) and scheduling capabilities.

## features

### manual operations

- manually back up radarr and sonarr instances.
- synchronize data between compatible instances.
- restore backups from the database.
- Attempt to restore specific downloaded releases based on history (Experimental).

### automatic operations

- scheduled backups (daily, weekly, monthly, or custom cron).
- automatic synchronization for parent-child instance relationships.
- Optionally back up detailed release history (indexer, GUID, etc.) during scheduled backups.
- filtering based on quality profiles, download folders, and tags.


## setup and installation

### prerequisites

- python 3.11 or later
- docker and docker compose
- required python packages (see [requirements.txt](requirements.txt) )

### installation steps

1. clone the repository:

   ```bash
   git clone https://github.com/lucanori/arrranger.git
   cd arrranger
   ```
   
2. install dependencies:

   ```
   pip3 install -r requirements.txt
   ```

3. set up the configuration:

   ```
   mkdir -p config
   cp arrranger_instances.json.example config/arrranger_instances.json
   ```
   edit config/arrranger_instances.json to configure your instances. refer to the [README.md](README.md) file for detailed configuration options

### docker setup

- build the docker image:
   ```
   docker build -t arrranger .
   ```
- run via Docker Compose:
   ```
   docker-compose up -d
   ```
- for local development:
   ```
   # ensure data directory with database exists and has proper permissions
   mkdir -p data
   touch data/arrranger.db
   chmod 777 data data/arrranger.db
   
   # run with local configuration
   docker compose -f docker-compose.local.yml up -d
   ```

## code structure

this section describes the organization and key components of the arrranger codebase

- `arrranger_sync.py` –  module handles the interactive user interface and manual operations. it includes functions for:
  - adding/removing media server instances
  - performing manual backups and synchronization
  - restoring from backups
  - displaying configured instances
   - handling release history backup and restore (Experimental)
   - contains `DatabaseManager` (database interactions including `instances` and `ReleaseHistory` tables) and `MediaServerManager` (API interactions, configuration, core logic including history fetching/restore)
- `arrranger_scheduler.py` – this module manages scheduled tasks, including:
  - automatic backups based on cron schedules defined in `arrranger_instances.json`
  - automatic synchronization between parent and child instances
- `arrranger_logging.py` – contains logging functions for consistent and informative output
- `arrranger_instances.json.example` –  sample configuration file demonstrating the structure and options available
- `Dockerfile` and `docker-compose.yml` – define the containerized environment
- `docker-compose.local.yml` - defines a local development environment with mounted volumes
- `config/` – directory for configuration files
- `data/` – stores data used or generated by the application, including the sqlite database (`arrranger.db`) which contains tables for `instances`, `movies`, `shows`, and `ReleaseHistory`.
- `requirements.txt` – lists the project's python dependencies

## environment variables

the application uses the following environment variables:

- `CONFIG_FILE` - path to the configuration file (default: `arrranger_instances.json` in the current directory)
- `DB_NAME` - path to the sqlite database file (default: `arrranger.db` in the current directory)
- `CONFIG_DIR` - directory containing configuration files (used in docker, default: `/config`)
- `DATA_DIR` - directory for storing data (used in docker, default: `/data`)

## usage

### running the application
- for manual operations, run:
   ```
   python arrranger_sync.py
   ```
- for scheduled tasks, run:
   ```
   python arrranger_scheduler.py
   ```

## development

### contribution guidelines
- follow PEP8 coding standards.
- add tests as necessary.
- document new features and update this guide accordingly.
- use Git for version control and create pull requests for code reviews.

### common issues and troubleshooting
- check Docker logs if containers fail to start: `docker logs arrranger-local`
- verify the configuration in `config/arrranger_instances.json`, ensuring proper JSON format with commas between elements.
- ensure all dependencies are installed correctly.

## additional resources
- refer to [README.md](README.md) for detailed usage instructions.
- consult the official documentation for Python, Docker, Docker Compose, [sonarr api docs](https://raw.githubusercontent.com/Sonarr/Sonarr/develop/src/Sonarr.Api.V3/openapi.json) and [radarr api docs](https://raw.githubusercontent.com/Radarr/Radarr/develop/src/Radarr.Api.V3/openapi.json)

Happy developing!